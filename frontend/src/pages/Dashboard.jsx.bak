import React, {useEffect, useState, useRef} from 'react'; import axios from 'axios'; import { Line } from 'react-chartjs-2'; import { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, TimeScale, Tooltip, Legend } from 'chart.js'; import { useAuth, apiWithAuth } from '../utils/auth'; ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, TimeScale, Tooltip, Legend);
export default function Dashboard(){ const [stocks,setStocks]=useState([]); const [selected,setSelected]=useState(null); const [prices,setPrices]=useState([]); const wsRef=useRef(null); const [messages,setMessages]=useState([]); const { user } = useAuth();
  useEffect(()=>{ axios.get('http://localhost:4000/api/stocks').then(r=>setStocks(r.data.stocks)).catch(()=>{}); },[]);
  useEffect(()=>{ if(selected) axios.get('http://localhost:4000/api/prices/'+selected).then(r=>setPrices(r.data.prices)).catch(()=>{}); },[selected]);
  useEffect(()=>{ wsRef.current = new WebSocket('ws://localhost:4000/ws'); wsRef.current.onmessage = (ev)=>{ try{ const d=JSON.parse(ev.data); if(d.type==='tick'){ setMessages(m=>[d,...m].slice(0,30)); if(d.symbol===selected) setPrices(p=>[...p,d.tick].slice(-500)); } else if(d.type==='alert'){ if(user && d.alert && d.alert.userId===user.id) alert('ALERT: '+JSON.stringify(d.alert)); } }catch(e){} }; return ()=> wsRef.current && wsRef.current.close(); },[selected,user]);
  async function runPredict(){ if(!selected) return alert('select a stock'); const r=await axios.post('http://localhost:4000/api/predict/'+selected); alert('Prediction: '+JSON.stringify(r.data.prediction)+'\nRisk: '+r.data.risk); }
  async function createAlert(symbol,target,type){ const token = localStorage.getItem('token'); if(!token) return alert('Please login to create alerts'); const api = await apiWithAuth(token); try{ const res = await api.post('/api/alerts',{symbol,target,type}); alert('Alert created: '+JSON.stringify(res.data.alert)); }catch(err){ alert(err?.response?.data?.error || 'failed'); } }
  const data = { labels: prices.map(p=> new Date(p.time).toLocaleTimeString()), datasets: [{ label: selected||'price', data: prices.map(p=>p.price), tension:0.2, fill:false, pointRadius:0 }] };
  return (<div className='grid grid-cols-4 gap-6'><div className='col-span-1 card p-4'><h2 className='font-semibold mb-2'>Stocks</h2><ul>{stocks.map(s=>(<li key={s.symbol} className={'p-2 rounded cursor-pointer '+(selected===s.symbol?'bg-blue-50':'hover:bg-gray-50')} onClick={()=>setSelected(s.symbol)}><div className='font-medium'>{s.symbol}</div><div className='text-sm text-gray-500'>{s.name}</div></li>))}</ul><div className='mt-4'><button className='px-3 py-2 btn-primary' onClick={runPredict}>Run Prediction</button></div><div className='mt-4'><h3 className='font-semibold'>Recent ticks</h3><div className='text-xs h-40 overflow-auto'>{messages.map((m,i)=>(<div key={i} className='py-1 border-b'><b>{m.symbol}</b> {m.tick?.price} <span className='text-gray-400'>({new Date(m.tick?.time).toLocaleTimeString()})</span></div>))}</div></div></div><div className='col-span-3 card p-4'><h2 className='font-semibold mb-2'>Chart â€” {selected||'select a stock'}</h2><div style={{height:350}}><Line data={data} /></div><div className='mt-4'><h3 className='font-semibold'>Create Alert</h3><CreateAlert symbol={selected} onCreate={createAlert} /></div></div></div>); }
function CreateAlert({symbol,onCreate}){ const [target,setTarget]=React.useState(''); const [type,setType]=React.useState('above'); async function submit(){ if(!symbol) return alert('select a stock'); await onCreate(symbol,+target,type); } return (<div className='flex gap-2 items-center mt-2'><input className='border rounded px-2 py-1' placeholder='target price' value={target} onChange={e=>setTarget(e.target.value)} /><select value={type} onChange={e=>setType(e.target.value)} className='border rounded px-2 py-1'><option value='above'>Above</option><option value='below'>Below</option></select><button className='px-3 py-1 btn-primary' onClick={submit}>Set</button></div>); }
