import React, { useEffect, useState, useRef } from 'react';
import axios from 'axios';
import { Line } from 'react-chartjs-2';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  TimeScale,
  Tooltip,
  Legend
} from 'chart.js';
ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, TimeScale, Tooltip, Legend);

export default function Dashboard(){
  const [stocks, setStocks] = useState([]);
  const [selected, setSelected] = useState(null);
  const [prices, setPrices] = useState([]);
  const [loading, setLoading] = useState(false);
  const [prediction, setPrediction] = useState(null);

  useEffect(()=>{
    axios.get('http://localhost:4000/api/stocks').then(r=>setStocks(r.data.stocks)).catch(()=>{});
  },[]);

  useEffect(()=>{
    if(!selected) return;
    setLoading(true);
    axios.get(`http://localhost:4000/api/prices/${selected}`).then(r=>{
      setPrices(r.data.prices || []);
      setLoading(false);
    }).catch(()=> setLoading(false));
  },[selected]);

  async function runPredict(){
    if(!selected) return alert('Select a stock first');
    try{
      const r = await axios.post('http://localhost:4000/api/predict', { symbol: selected });
      setPrediction(r.data);
      alert('Prediction: '+r.data.recommendation+' (risk: '+(r.data.risk||0).toFixed(3)+')');
    }catch(err){
      alert(err?.response?.data?.error || 'Prediction failed');
    }
  }

  const chartData = React.useMemo(()=>{
    const labels = prices.map(p=> new Date(p.time).toLocaleTimeString());
    const ds = prices.map(p=> p.price);
    return {
      labels,
      datasets: [{
        label: selected || 'Prices',
        data: ds,
        tension: 0.3,
        fill: true,
        pointRadius: 0
      }]
    };
  }, [prices, selected]);

  const chartOptions = {
    responsive: true,
    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
    scales: {
      x: { display: true },
      y: { display: true, beginAtZero: false }
    }
  };

  return (
    <div className='p-6'>
      <div className='flex items-center justify-between mb-4'>
        <h2 className='text-2xl font-semibold'>Dashboard</h2>
        <div className='space-x-2'>
          <button className='px-3 py-1 btn-primary' onClick={runPredict}>Run AI Recommendation</button>
          <a className='px-3 py-1 btn-outline' href="/portfolio">My Portfolio</a>
        </div>
      </div>
      <div className='grid grid-cols-4 gap-6'>
        <div className='col-span-1 bg-white p-4 rounded shadow'>
          <h3 className='font-medium mb-2'>Stocks</h3>
          <ul>
            {stocks.map(s=> (
              <li key={s.symbol} className={'p-2 cursor-pointer rounded ' + (selected===s.symbol ? 'bg-gray-100' : '')}
                  onClick={()=> setSelected(s.symbol)}>
                <div className='flex justify-between'>
                  <span>{s.symbol}</span>
                  <small className='text-gray-500'>{s.name}</small>
                </div>
              </li>
            ))}
          </ul>
        </div>
        <div className='col-span-3 bg-white p-4 rounded shadow'>
          <h3 className='font-medium mb-2'>{selected || 'Select a stock'}</h3>
          {loading ? <div>Loading chart...</div> : (
            prices.length>0 ? <Line data={chartData} options={chartOptions} /> : <div>No data</div>
          )}
          {prediction && prediction.symbol===selected && (
            <div className='mt-3 p-3 rounded border'>
              <strong>Recommendation:</strong> {prediction.recommendation} &nbsp; <br/>
              <strong>Short SMA:</strong> {prediction.short.toFixed(2)} &nbsp;
              <strong>Long SMA:</strong> {prediction.long.toFixed(2)} &nbsp;
              <strong>Risk:</strong> {(prediction.risk||0).toFixed(3)}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
